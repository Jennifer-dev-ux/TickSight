<?php
/** @var string $pageTitle */
/** @var array<string> $cities */
/** @var array<int> $years */
/** @var array<string> $speciesList */
/** @var string|null $selectedCity */
/** @var int|null $selectedYear */
/** @var string $selectedSpecies */
/** @var array<int,int> $monthlyCounts */
/** @var array<string,array{topCities:array,peakMonth:?string}> $speciesStats */


?>

<section class="education-section">
    <h3>Tick species & prevention</h3>

    <section aria-labelledby="species-guide-title">
        <h4 id="species-guide-title">Species identification guide</h4>
        <p class="hint">
            These are some of the most commonly reported tick species.
        </p>

        <div class="species-grid">
            <article class="species-card">
                <h5>Passerine tick</h5>
                <p class="species-latin"><em>Dermacentor frontalis</em></p>
                <p>
                    Often associated with birds and found in wooded or park areas.
                    Small and easy to miss, so careful checking after time outdoors is important.
                </p>

                <?php
                $stats = $speciesStats['Passerine tick'] ?? null;
                $topCities = $stats['topCities'] ?? [];
                $peakMonth = $stats['peakMonth'] ?? null;
                ?>
                <p class="hint">
                    <?php if (!empty($topCities)): ?>
                        Mostly found in:
                        <?= htmlspecialchars($topCities[0], ENT_QUOTES, 'UTF-8') ?>
                        <?php if (!empty($topCities[1])): ?>
                            and <?= htmlspecialchars($topCities[1], ENT_QUOTES, 'UTF-8') ?>
                        <?php endif; ?>.
                        <br>
                    <?php endif; ?>

                    <?php if (!empty($peakMonth)): ?>
                        Most common in: <?= htmlspecialchars($peakMonth, ENT_QUOTES, 'UTF-8') ?>.
                    <?php else: ?>
                        Not enough data yet to show when this tick is most active.
                    <?php endif; ?>
                </p>
            </article>


            <article class="species-card">
                <h5>Fox/badger tick</h5>
                <p class="species-latin"><em>Ixodes canisuga</em></p>
                <p>
                    Common on wildlife like foxes and badgers, but can also attach to dogs and people.
                    Frequently found in more rural or edge-of-woodland environments.
                </p>
                <?php
                $stats = $speciesStats['Fox/badger tick'] ?? null;
                $topCities = $stats['topCities'] ?? [];
                $peakMonth = $stats['peakMonth'] ?? null;
                ?>
                <p class="hint">
                    <?php if (!empty($topCities)): ?>
                        Mostly found in:
                        <?= htmlspecialchars($topCities[0], ENT_QUOTES, 'UTF-8') ?>
                        <?php if (!empty($topCities[1])): ?>
                            and <?= htmlspecialchars($topCities[1], ENT_QUOTES, 'UTF-8') ?>
                        <?php endif; ?>.
                        <br>
                    <?php endif; ?>

                    <?php if (!empty($peakMonth)): ?>
                        Most common in: <?= htmlspecialchars($peakMonth, ENT_QUOTES, 'UTF-8') ?>.
                    <?php else: ?>
                        Not enough data yet to show when this tick is most active.
                    <?php endif; ?>
                </p>
            </article>

            <article class="species-card">
                <h5>Southern rodent tick</h5>
                <p class="species-latin"><em>Ixodes acuminatus</em></p>
                <p>
                    Mostly feeds on small mammals such as rodents. Sightings can indicate local rodent activity,
                    especially around gardens, allotments, or storage areas.
                </p>
                <?php
                $stats = $speciesStats['Southern rodent tick'] ?? null;
                $topCities = $stats['topCities'] ?? [];
                $peakMonth = $stats['peakMonth'] ?? null;
                ?>
                <p class="hint">
                    <?php if (!empty($topCities)): ?>
                        Mostly found in:
                        <?= htmlspecialchars($topCities[0], ENT_QUOTES, 'UTF-8') ?>
                        <?php if (!empty($topCities[1])): ?>
                            and <?= htmlspecialchars($topCities[1], ENT_QUOTES, 'UTF-8') ?>
                        <?php endif; ?>.
                        <br>
                    <?php endif; ?>

                    <?php if (!empty($peakMonth)): ?>
                        Most common in: <?= htmlspecialchars($peakMonth, ENT_QUOTES, 'UTF-8') ?>.
                    <?php else: ?>
                        Not enough data yet to show when this tick is most active.
                    <?php endif; ?>
                </p>
            </article>

            <article class="species-card">
                <h5>Marsh tick</h5>
                <p class="species-latin"><em>Ixodes apronophorus</em></p>
                <p>
                    Often associated with damp or marshy environments.
                    Extra care is needed after walks near wetlands, streams, or poorly drained ground.
                </p>
                <?php
                $stats = $speciesStats['Marsh tick'] ?? null;
                $topCities = $stats['topCities'] ?? [];
                $peakMonth = $stats['peakMonth'] ?? null;
                ?>
                <p class="hint">
                    <?php if (!empty($topCities)): ?>
                        Mostly found in:
                        <?= htmlspecialchars($topCities[0], ENT_QUOTES, 'UTF-8') ?>
                        <?php if (!empty($topCities[1])): ?>
                            and <?= htmlspecialchars($topCities[1], ENT_QUOTES, 'UTF-8') ?>
                        <?php endif; ?>.
                        <br>
                    <?php endif; ?>

                    <?php if (!empty($peakMonth)): ?>
                        Most common in: <?= htmlspecialchars($peakMonth, ENT_QUOTES, 'UTF-8') ?>.
                    <?php else: ?>
                        Not enough data yet to show when this tick is most active.
                    <?php endif; ?>
                </p>
            </article>

            <article class="species-card">
                <h5>Tree-hole tick</h5>
                <p class="species-latin"><em>Ixodes arboricola</em></p>
                <p>
                    Frequently found in tree holes or cavities used by birds.
                    People and pets can pick up these ticks when spending time in mature woodland or parks.
                </p>
                <?php
                $stats = $speciesStats['Tree-hole tick'] ?? null;
                $topCities = $stats['topCities'] ?? [];
                $peakMonth = $stats['peakMonth'] ?? null;
                ?>
                <p class="hint">
                    <?php if (!empty($topCities)): ?>
                        Mostly found in:
                        <?= htmlspecialchars($topCities[0], ENT_QUOTES, 'UTF-8') ?>
                        <?php if (!empty($topCities[1])): ?>
                            and <?= htmlspecialchars($topCities[1], ENT_QUOTES, 'UTF-8') ?>
                        <?php endif; ?>.
                        <br>
                    <?php endif; ?>

                    <?php if (!empty($peakMonth)): ?>
                        Most common in: <?= htmlspecialchars($peakMonth, ENT_QUOTES, 'UTF-8') ?>.
                    <?php else: ?>
                        Not enough data yet to show when this tick is most active.
                    <?php endif; ?>
                </p>
            </article>
        </div>
    </section>


    <section aria-labelledby="seasonal-chart-title">
        <h4 id="seasonal-chart-title">Activity by city</h4>
        <p class="hint">
            This chart shows how many tick sightings were reported each month for a selected UK city and year.
        </p>

        <form method="get" action="../index.php" class="chart-filters">
            <input type="hidden" name="page" value="education">

            <label>
                City
                <select name="city">
                    <?php foreach ($cities as $city): ?>
                        <option value="<?= htmlspecialchars($city, ENT_QUOTES, 'UTF-8') ?>"
                                <?= ($selectedCity === $city) ? 'selected' : '' ?>>
                            <?= htmlspecialchars($city, ENT_QUOTES, 'UTF-8') ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </label>

            <label>
                Year
                <select name="year">
                    <?php foreach ($years as $year): ?>
                        <option value="<?= (int)$year ?>"
                                <?= ((int)$selectedYear === (int)$year) ? 'selected' : '' ?>>
                            <?= (int)$year ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </label>

            <label>
                Tick species
                <select name="species">
                    <option value="">All species</option>
                    <?php foreach ($speciesList as $species): ?>
                        <option value="<?= htmlspecialchars($species, ENT_QUOTES, 'UTF-8') ?>"
                                <?= ($selectedSpecies === $species) ? 'selected' : '' ?>>
                            <?= htmlspecialchars($species, ENT_QUOTES, 'UTF-8') ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </label>

            <button type="submit">Update chart</button>
        </form>

        <div class="chart-wrapper">
            <canvas id="seasonChart" aria-label="Seasonal tick activity chart" role="img"></canvas>
        </div>
    </section>
</section>

<?php
// Prepare data for js
$monthlyCountsArray = array_values($monthlyCounts ?? []);
?>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const monthlyCounts   = <?= json_encode($monthlyCountsArray, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) ?>;
    const selectedCity    = <?= json_encode($selectedCity, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) ?>;
    const selectedYear    = <?= json_encode($selectedYear, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) ?>;
    const selectedSpecies = <?= json_encode($selectedSpecies ?? '', JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) ?>;

    const ctx = document.getElementById('seasonChart');

    if (ctx && Array.isArray(monthlyCounts)) {
        const labels   = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const maxCount = monthlyCounts.length ? Math.max(...monthlyCounts) : 0;

        console.log('monthlyCounts:', monthlyCounts, 'maxCount:', maxCount);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sightings per month',
                    data: monthlyCounts,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: maxCount <= 1 ? 5 : maxCount + 1,
                        ticks: {
                            stepSize: 1
                        },
                        title: { display: true, text: 'Number of sightings' }
                    },
                    x: {
                        title: { display: true, text: 'Month' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: (function () {
                            if (!selectedCity || !selectedYear) return 'Seasonal tick activity';
                            if (selectedSpecies) {
                                return `Sightings in ${selectedCity} (${selectedYear}) – ${selectedSpecies}`;
                            }
                            return `Sightings in ${selectedCity} (${selectedYear}) – All species`;
                        })()
                    }
                }
            }
        });
    }

</script>



